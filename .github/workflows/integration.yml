name: Pull request validation

on:
  pull_request:
    branches:
      - main
      - release/**
    types:
      - opened
      - reopened
      - synchronize
      - edited

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_ENV: test
  CI: true

  DB_URL: 'postgresql://user:PasswordSAMPLE@localhost:5432/hopper'
  DB_POOL_SIZE: 40
  DB_CONN_TIMEOUT_MS: 30000
  DB_LOGS_ENABLED: false

  LOG_SILENCE: false

  SERVER_PORT: 8080
  SERVER_TIMING_DEBUG: false
  SERVER_TIMEOUT_MS: 30000
  SERVER_MAX_BODY_SIZE_KB: 128
  SERVER_CORS_ORIGIN: example.com
  SERVER_ERROR_DEBUG: false

  REDIS_URL: 'redis://localhost:6379/0'

  SMTP_HOST: smtp.ethereal.email
  SMTP_PORT: 587
  SMTP_USER: someone@ethereal.email
  SMTP_PASS: PasswordSAMPLE
  SMTP_TLS_ENABLED: true

  REVISION: ${{ github.event.pull_request.head.sha }}

jobs:
  code-quality:
    name: Check code quality
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository

      - uses: github/codeql-action/init@v4
        name: Initialize GitHub CodeQL
        with:
          languages: ${{ matrix.language }}

      - uses: github/codeql-action/analyze@v4
        name: Perform CodeQL analysis
        with:
          category: '/language:${{ matrix.language }}'

  pull-request-sanity:
    name: Pull request sanity
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository
        with:
          fetch-depth: 0

      - run: |
          docker pull zricethezav/gitleaks:latest
          docker run -v ./:/path zricethezav/gitleaks:latest git --platform github /path
        name: Check for leaked secrets

      - uses: oven-sh/setup-bun@v2
        name: Install bun runtime
        with:
          bun-version-file: '.bun-version'

      - run: |
          bun install --frozen-lockfile
          bun install -g @commitlint/cli @commitlint/config-conventional
        name: Install dependencies

      - run: echo "${{ github.event.pull_request.title }}" | bunx commitlint
        name: Check pull request title

      - run: bunx validate-branch-name -t ${{ github.event.pull_request.head.ref }}
        name: Check branch naming convention

      - run: |
          npx commitlint \
            --from ${{ github.event.pull_request.base.sha }} \
            --to ${{ github.event.pull_request.head.sha }} --verbose
        name: Check commit messages in pull request

  code-sanity:
    name: Code sanity
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository

      - uses: oven-sh/setup-bun@v2
        name: Install bun runtime
        with:
          bun-version-file: '.bun-version'

      - run: bun install --frozen-lockfile
        name: Install dependencies

      - run: bun run format:check
        name: Check for formatting errors

      - run: bun run lint:check
        name: Check for lint errors

      - run: bun run typecheck
        name: Check for type errors

      - run: bun run build
        name: Transpile the application

  database-check:
    name: Check database and entity sanity
    runs-on: ubuntu-latest

    env:
      DB_LOGS_ENABLED: true

    services:
      postgres:
        image: postgres:18.1-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: PasswordSAMPLE
          POSTGRES_DB: hopper
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository

      - uses: oven-sh/setup-bun@v2
        name: Install bun runtime
        with:
          bun-version-file: '.bun-version'

      - run: bun install --frozen-lockfile
        name: Install dependencies

      - run: make migration:apply
        name: Apply all pending migrations

      - run: make seeder:apply
        name: Apply all pending seeders

      - run: |
          set +e
          make migration:generate name="update-database-schema-in-test"
          code=$?

          set -e

          if [ "$code" -eq 0 ]; then
            echo "Schema deviation identified. Please check if the entities and migrations are aligned."
            exit 1
          fi
        name: Evaluate database schema deviation

  test:
    name: Run tests and report
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read
      pull-requests: write

    services:
      postgres:
        image: postgres:18.1-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: PasswordSAMPLE
          POSTGRES_DB: hopper
        ports:
          - 5432:5432

      redis:
        image: redis:8.4-alpine
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository

      - uses: oven-sh/setup-bun@v2
        name: Install bun runtime
        with:
          bun-version-file: '.bun-version'

      - run: bun install --frozen-lockfile
        name: Install dependencies

      - run: make test:coverage
        name: Run test cases and collect stats
        env:
          LOG_SILENCE: true

      - uses: davelosert/vitest-coverage-report-action@v2
        name: Report code coverage to pull request
        if: ${{ !cancelled() }}
        with:
          file-coverage-mode: none
          threshold-icons: "{0: 'üî¥', 80: 'üü†', 90: 'üü¢'}"

      - uses: actions/github-script@v8
        name: Prepare test result report
        if: ${{ !cancelled() }}
        with:
          script: |
            const { readFileSync, writeFileSync } = require("fs");

            const {
              GITHUB_RUN_NUMBER,
              GITHUB_RUN_ID,
              SHA,
              GITHUB_SERVER_URL,
              GITHUB_REPOSITORY
            } = process.env;

            const shortSha = SHA.slice(0, 7);
            const runUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;
            const commitUrl = `${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${SHA}`;

            const json = JSON.parse(readFileSync('junit.json'));
            const content = `## ${json.success ? '‚úÖ' : '‚ùå'} Test Suite ${json.success ? 'Passed' : 'Failed'}

            | Total | Passed | Failed | Pending | Todo | Skipped |
            |-------|--------|--------|---------|---------|---------|
            |   ${json.numTotalTests}    |    ${json.numPassedTests}    |    ${json.numFailedTests}    |    ${json.numPendingTests}     |    ${json.numTodoTests}     |    ${json.numTotalTests - json.numPassedTests - json.numFailedTests - json.numPendingTests - json.numTodoTests}     |

            _Generated in workflow [#${GITHUB_RUN_NUMBER}](${runUrl}) for commit [${shortSha}](${commitUrl})_
            `;

            writeFileSync("result.md", content);
        env:
          SHA: ${{ github.event.pull_request.head.sha }}

      - uses: thollander/actions-comment-pull-request@v3
        name: Report test result to pull request
        if: ${{ !cancelled() }}
        with:
          file-path: result.md
          comment-tag: test-result-report
          mode: upsert

  containerize:
    name: Containerize the application
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        name: Checkout the code repository

      - run: |
          echo "::group::Start the docker image using compose"
          docker compose up -d
          echo "::endgroup::"

          echo "::group::Check the running containers"
          sleep 5
          docker ps
          echo "::endgroup::"

          echo "::group::Ping the application server health endpoint"
          mkdir -p out
          curl -s -v -o out/response.json http://localhost:8080/api/v1/health
          echo "::endgroup::"

          echo "::group::Check the health status of the application"
          jq . out/response.json
          grep -i "isHealthy" out/response.json
          echo "::endgroup::"
        name: Run the image using docker compose

  guard:
    name: Pull request validation guard
    runs-on: ubuntu-latest

    needs:
      - code-quality
      - pull-request-sanity
      - code-sanity
      - database-check
      - test
      - containerize

    steps:
      - run: echo "‚úÖ all necessary checks passed"
        name: Success notification
